# MAC(medium access control)

## 链路

两种类型的链路：

+ 点对点链路
+ 广播链路



## 多路访问链路的特性

+ 单一共享广播信道
+ 两个或者多个节点同时传输
+ 节点同时接收到两个或多个信号，会发生碰撞



## 多路访问协议

+ 分布式算法决定节点什么时候可以传输
+ 没有信道共享的通信必须使用信道本身
+ 没有用于协调的其他信道



## 一个理想的多路访问协议

基于一个速率为R bps的广播信道：

+ 当一个节点想要传输数据时，它可以以速率R进行传输
+ 当有M个节点想要传输数据时，每个节点可以以平局速率R/M进行传输
+ 完全分散式：没有特殊节点来协调传输，没有时钟同步或时间槽的要求
+ 简单：协议应该简单易实现





## 多路访问的三种协议

### 信道划分

#### 时分多址（TDMA）

+ 在TDMA中，信道被分为固定长度的时隙以及轮次。每个节点在每个轮次中获得一个固定长度的时隙来进行数据传输
+ 如果某个站点没有数据要传输，它的时隙将保持空闲状态。只有具有数据传输的站点才会利用它们的时隙进行数据传输



| 优点                                                         | 缺点                                                       |
| ------------------------------------------------------------ | ---------------------------------------------------------- |
| 提供了严格的时间分割，每个节点都有确定的时隙用于数据传输，避免了碰撞的产生 | 如果某些站点的时隙未被使用，它们将会浪费掉，造成资源的浪费 |



#### 频分多址（FDMA）

+ 在FDMA中，每个节点被分配一个固定的频带用来数据传输。整个信道的频谱被划分为多个不重叠的频带，每个频带用与一个节点的数据传输
+ 如果某个节点没有数据要传输，它的频带将处于空闲状态，只有数据要传输的站点才会利用它们被分配的频带进行数据传输



| 优点                                                         | 缺点                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 提供了严格的频带分割，每个节点都有确定的频带用于数据传输，避免了碰撞的产生 | 如果某些站点的频带未被使用，它们将会浪费掉，造成资源的浪费。需要精准的频率划分和站点之间的频率同步 |



#### 码分多址（CDMA）

+ 主要用于无线广播通道
+ 所有的节点共享相同的频率，但每个节点都有自己的扩频序列（码集）用于编码数据
+ $编码信号 = （原始数据）* （扩频序列）$



| 优点                                                         | 缺点                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 在共享频率的基础上，利用扩频技术将数据进行编码和解码，从而实现多节点同时传输数据而减少互相干扰的程度 | 接收端需要准确识别和提取特地昂节点的编码信号，并抑制其他节点的干扰 |
| 抗干扰和抗多径传播                                           | CDMA系统的性能受到系统容量和码间干扰等因素的限制             |



### 轮流

#### 轮询

+ 主节点依次邀请从节点进行传输
+ 通常和“无智能”从节点一起使用
+ 关心：
  + 轮询开销
  + 延迟
  + 单点故障（主节点）
+ 应用：蓝牙



#### 令牌传递

+ 控制令牌按顺序从一个节点传递到下一个节点
+ 令牌用于消息传递
+ 关心：
  + 令牌开销
  + 延迟
  + 单点故障（令牌）
+ 应用：令牌环、FDDI（光纤分布式数据接口）





### 随机访问

+ 当节点有数据包要发送时，以满速率R践行传输
+ 节点之间没有预先的协调
+ 如果有两个或者多个节点同时发送数据包，会发生碰撞
+ 随机访问MAC协议规定：
  + 如何检测和避免碰撞
  + 如何从碰撞中恢复过来
+ 随机访问MAC协议的例子有
  + ALOHA，分槽ALOHA
  + CSMA，CSMA/CD，CSMA/CA



#### ALOHA

##### 发送方

+ 如果节点有数据帧时，立即发送
+ 如果收到确认（ACK），表示传输成功
+ 如果没有收到确认，以概率p重新发送，并以概率（1-p）等待
+ 如果重复传输后仍然没有收到确认，放弃传输



##### 接收方

+ 使用帧校验序列
+ 如果帧正常且与接收方匹配，发送确认（ACK）
+ 帧可能受到噪声或者碰撞的干扰
+ 当同时有其他节点传输时，帧可能发生重叠，引起碰撞





#### 时隙ALOHA

+ 所有帧具有相同的大小

+ 所有帧被分割为长度等于帧传输时间的(T0)的统一时隙

+ 节点同步的(需要中央时钟或其他同步机制)

+ 传输始于时隙边界

+ 帧要么完全错过边界，要么完全重叠

+ 运行方式：
  + 当节点获取到新的帧的时，在下一个时隙中进行传输
  
  + 如果没有发生碰撞，节点可以在下一个时隙中发送新的帧
  
  + 如果发生了碰撞，节点会以概率p在每个后续时隙中重新传输帧，直到成功为止
  
    

#### CSMA(载波侦听多路访问)

+ CSMA要求在发送之前先进行侦听
+ 如果信道被侦听到是空闲的，节点会传输整个帧
+ 如果信道被侦听到是忙碌的， 节点会延迟传输
+ 类比：不要打断别人
+ 但是因为传播延迟的存在，CSMA无法消除所有的碰撞
  + 从节点侦听到信道为空闲到节点实际开始传输数据之间存在一定的时间差
  + 如果多个节点同时侦听到信道为空闲的，并且在同一时间开始传输数据，仍会发生碰撞
  + CSMA只能通过减少碰撞的概率可以提高整体的传输效率
  + 如果了两个节点之间距离比较远，传播延迟较大，那么碰撞的概率就会增加



##### 非持续CSMA

+ 当一个节点希望发送数据时，它首先监听信道
+ 如果信道空闲，节点开始发送数据；否则，它进入等待状态
+ 在等待状态中，节点等待一段随机时间(延迟)，然后回到步骤1

| 优点                                                         | 缺点                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 使用随机延迟来降低碰撞的概率，由于每个节点等待的时间是随机的，因此等待时间不同的节点是随机的 | 每个站点只进行一次监听，如果信道在发送之前变为忙碌状态，节点需要等待随机延迟再次进入监听，这样会浪费一部分的信道容量。 |
| 。。。                                                       | 即便有一个或多个节点在等待发送，但是信道在传输结束后仍然可能处于空闲状态，导致容量的浪费 |



##### 1-持续CSMA

+ 当一个节点节点希望发送数据时，它首先监听信道
  + 1：如果信道空闲，节点立即发送数据；否则进入步骤2
  + 2：如果信道忙碌，节点持续监听信道，直到信道变为空闲，然后立即发送数据
+ 在这种CSMA中，站点是自私的，它们希望尽快地发送数据。如果两个或者更多的站点在等待发送，碰撞是不可避免的。
+ 目前以太网使用的是这种方式，因为以太网星型拓扑的方式使其碰撞的概率很低，并且这种方式的速度会更快



##### p-持续CSMA

+ 1：如果信道空闲，以概率p发送数据，以概率(1-p)延迟一个时间单位
  + 一般情况下，时间单位等于最大传播延迟
+ 2：如果信道忙碌，监听信道直到空闲，并且重复步骤1
+ 3：如果被延迟一个时间单位，重复步骤1



在这种CSMA中，p的取值对性能有影响

+ 如果p过小，将导致较低的通信利用率和较长的延迟
+ 如果p过大，将导致较高的碰撞率
+ 选取p值是关键，信道负载和网络拓扑



##### CSMA/CD（碰撞检测）

+ 1：当信道空闲，进行传输；否则，执行步骤2
+ 2：如果信道忙碌，监听信道，直到检测到空闲，然后立即进行传输
+ 如果检测到碰撞，发送干扰信号，然后中止传输
+ 在发送干扰信号后，等待一段随机时间，然后从步骤1开始



为什要发送干扰信号：信号在基带总线传输过程中会因为距离的增加而衰减，需要使用干扰信号(jam)来指示发生了碰撞

对最小帧和最大距离进行了限制（优化碰撞检测，最大程度减少碰撞引起的数据损坏或丢失的可能）：

+ 最小镇大小：设置最小帧的大小可以确保发送站点的信号在网络介质上持续一段时间。这样其他节点可以检测到传输和潜在的碰撞。如果帧大小太小，信号的持续时间会很短，其他节点难以准确地检测到碰撞
+ 最大距离：限制网络的最大距离有助于保持信号完整性和控制信号衰减。随着信号传播的距离增加，它会变弱并且可能无法与背景噪声区分开。通过限制距离，网络可以确保信号强度足够以实现可靠的通信和碰撞检测


$$
B:带宽\\
L:链路长度\\
V:传播速度\\
Size:碰撞检测\\
传播时间:Ta = L/v\\
在最坏情况下，碰撞检测需要2Ta的时间\\
最小争用间隔 = 2Ta\\
最小帧大小：\\
如果一个帧的传输时间小于2Ta,那么如果发生碰撞，可能无法检测到碰撞\\
为了确保碰撞检测，必须满足Tb >= 2Ta\\
最小帧大小为size >= 2LB/v
$$




#### 随机访问的三个关键思想

##### 载波监听

+ 在发言之前先听，并且不要打断别人
+ 检查是否有其他节点正在发送数据
+ 等待直到其他节点完成

##### 碰撞检测

+ 如果有其他节点同时发送，立即停止
+ 确保每个节点都直到发生了碰撞
+ 检测到数据在传输线上损坏，意味着两个节点同时传输

##### 随机性

+ 不要立即重新开始传输
+ 在尝试之前等待一个随机的时间



#### 选择

选择了1-持续CSMA：

+ 非持续性和p-持续性都存在着一定的性能问题
+ 由于碰撞所浪费的时间都很短暂
+ 通过随机退避，下次传输的概率很低会再次发生

使用了二进制指数退避机制



##### 二进制指数退避

+ 如果发生了重复碰撞，会反复尝试传输数据
+ 在前10次尝试中，随机延迟的平均值会加倍，在接下来6次的尝试中延迟值保持不变，经过16次不成功尝试后，节点放弃传输并且报告错误

采用二进制指数退避的1-持续算法在广泛的负载范围内高效：

+ 低负载：保证了效率
+ 高负载：和其他技术一样稳定
+ 后进先出：碰撞较少的节点先传输



#### CSMA/CD的总结

+ 网卡从网络层接收数据包，创建帧
+ 传输帧
  + 如果网卡检测到信道空闲，开始传输帧
  + 如果网卡检测到信道忙碌，等待信道空闲，然后传输
+ 完成传输？
  + 如果网卡在没有检测到其他传输的情况下成功传输整个帧，网卡完成传输
  + 如果网卡在传输过程中检测到其他传输，中止传输并发送干扰信号
+ 中止传输
  + 中止传输后，网卡进入二进制(指数)退避过程
    + 在m次碰撞后，网卡从{0, ... , 2^m-1^}中随机选择K，网卡等待K * 512位时间，然后返回到第二步
    + 碰撞次数越多，退避间隔越长





## MAC地址和发现

一个主机“出生“”的时候，它的MAC地址就被知道了（“出生号”）

### ARP和DHCP

ARP（地址解析协议）和DHCP（动态主机配置协议）是计算机网络中使用的两种链路层发现协议。它们都局限于单个局域网(LAN)并且依赖于网络的广播功能。

+ ARP用于在基于IP的网络中根据设备的IP地址解析以太网或MAC地址。通过广播ARP请求消息来收到包含MAC地址的ARP恢复消息
+ DHCP用于动态分配IP地址和其他网络配置参数给网络中的设备。DHCP消除了手动配置IP地址、子网掩码、默认网关和其他网络设备的需求。当设备加入网络时，他会广播DHCP发现消息以请求



### DHCP

一个主机可以使用DHCP去发现：

+ 字节的IP地址
+ 子网掩码：子网掩码用于确定主机所在的子网的范围，帮助主机判断哪些IP地址属于本地网络
+ 本地DNS服务其的IP地址：主机可以获取分配给它的本地域名服务器的IP地址，这样他就可以解析域名并进行网络通信了
+ 默认路由器的IP地址：主机可以获取分配给它默认网关（第一跳路由器）的IP地址，这样它就知道将数据包发送到互联网或其他网络时应该经过哪个路由器了



过程：

1. 客户端广播DHCP-DISCOVER消息在子网中
2. 每个收到DHCP-DISCOVER消息的服务器会发送一个DHCP-OFFER消息，其中包含可提供给客户端的IP地址和其他配置消息
3. 客户选择DHCP服务器并广播DHCP-REQUEST消息
4. 被选择DHCP服务器收到REQUEST消息之后，发送一个DHCP-ACK消息，其中包含给客户端分配的IP地址和其他配置信息
5. 客户会使用DHCP-ACK中的配置参数来应用于自己的网络设置
6. 客户端可以通过发送DHCP-RELEASE来释放与DHCP服务器的绑定关系
7. 客户端和DHCP服务器是绑定关系，绑定关系通常会有一个租期。



#### 发生了故障

+ 如果主机发生故障无法和DHCP服务器进行通信，那么DHCP服务器会在租期过期后将主机之前使用的IP地址重新设置为可分配状态
+ 如果服务器发生了故障，无法进行ACK恢复：
  + 主机在不收到ACK消息时，无法进行IP地址和其他配置的设置
  + 主机XYZ释放IIP地址并发送新请求：主机XYZ将在租期结束后释放自己的IP地址，并重新发送请求
  + 如果一个新的DHCP服务器上线，客户可以重新发送DHCP请求，并获得新的IP地址和配置信息
+ 如果网络发生了故障
  + 那么更新租期和收到来自服务器的ACK将不再能够收到
  + 网络故障了，那么主机可能会因为不能和DHCP联系而主动释放IP地址
  + DHCP服务器可以在主机主动释放地址后，将该地址设置为可分配



### ARP

简单来说，ARP就是用来得到一个IP到MAC地址的映射

+ 只能用在局域网中
+ 和DNS比较：其是一个应用层协议，并且其是获得一个域名到IP之间的映射



过程：

每个主机维护一个IP到MAC地址的映射

发送方：

+ 在发送之前首先查找本地的ARP缓存表，如果没有找到，则构建一个ARP request，并标注发送方IP，发送方MAC，目的IP
+ 发送方以MAC帧的形式广播该ARP请求



接收方

+ 接收方在收到了一个ARP请求后，如果和自己的IP一致，那么建立一个ARP reply恢复，在其中插入目的IP，目的MAC
+ 接收方将以MAC帧的形式放松给发送方主机



发送方和接收方都会将对方的MAC地址和IP地址加入到自己的映射表中，并记录时间戳以用于更新和超时



#### 如果是远程目的地呢？

1. 主机首先会检查本地ARP表，查看是否已经有了相应的MAC地址。
2. 如果没找到，主机通过网络掩码知道该该目的不是本地的。
3. 知道不是本地的话，主机将会将目标IP作为目的IP的数据包发送给路由器，由路由器将这个包发送给目的地址



### DHCP和ARP联系：

+ 广播：这两个协议都使用广播俩进行初始联系
+ 可扩展性：广播使得这些协议可以适应大型网络，只在子网的广播域中进行广播
+ 缓存：ARP缓存和DHCP的租约数据库
+ 软状态：有限的生存期
+ 鲁棒性：动态学习能力和遗忘信息的能力对于网络的稳健性很重要。



###  发现的两种机制

+ 广播：广播方式在规模上存在问题，不适合大型网络。但它没有集中的故障点，具有零配置的优点。
+ 目录服务：DNS的根节点是关键的点，如果出现了故障将会导致整个目录服务不可用，因此缓存是关键。DNS服务需要一些配置来引导启动。



