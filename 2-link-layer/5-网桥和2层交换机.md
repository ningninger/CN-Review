# 网桥和二层交换机



## 局域网之间的互联

局域网的互联能力使得其能够扩展到单个局域网之外，并提供与其他互联网\广域网之间的互联。

这使用了桥接器（后来的二层交换机）。

+ 桥接器用于连接多个局域网，通常不止两个局域网
+ 在物理层和介质访问控制层使用相同的协议，确保互联的互联网之间可以无缝通信。
+ 桥接器可以存储并转发局域网帧
+ 精确地逐位复制帧
+ 提供交换（路由）功能



## 网桥的要求

桥接器需要满足的要求：

+ 存储和转发：桥接器能够读取在一个局域网上传输的帧，检查帧的MAC地址，并有选择性地将这些地址存储到其他局域网上。使用MAC协议传输每个帧
+ 透明：桥接器对于终端设备来说是透明的
+ 即插即用和自学习：桥接器能够学习和存储源MAC地址和相应的端口之间的映射关系。通过观察帧的来源，桥接器可以动态地构建和更新MAC地址表，以便有效地转发帧



## 网桥的机制

+ 帧广播：当桥接器接收到一个帧的时候，它会广播该帧到所有其他连接的局域网上，以便确保帧能够到达目标设备。
+ 环路解决：在具有多个桥接器的网络中，可能会出现环路问题，导致帧在网络中无线循环。为了解决这个问题，透明桥接器使用了一种“生成树“协议来检测和消除环路。
+ 地址学习：透明桥接器会观察传入的帧，并学习源MAC地址和相应的端口之间的映射。它会将这些映射关系存储在一个称为MAC地址表的表中。



## 广播风暴问题

+ 最简单的方式去避免环路
  + 使用不可能出现环路的拓扑结构
  + 选择特定的拓扑结构，并且生成一个生成树
    + 这个生成树的子图不包含圈（实际上是个废话啊，树的定义是最大的无圈连通图）
    + 不再这个树中的链路是不会用来转发帧的





### 生成树协议

STP协议的特性：

+ 无须配置：桥接器在网络中自动生成构建生成树，无须任何操作或用户的手动配置
+ 自愈性：可以检测并消除可能导致环路的链路。当网络中发生链路故障或者拓扑结构发生了改变，STP可以重新计算生成数
+ 当今仍在使用：尽管还有其他的生成树协议RSTP，但是STP仍在被广泛地支持



### 生成树算法

+ 生成树算法中节点表示桥接器（或者交换机）

+ 将任意网络拓扑作为输入
+ 选择形成生成树的链路子集



两个方面：

+ 选择一个根节点：
  + 最短路径的目的地
  + 选择具有最小标识符的节点作为根节点（一般将MAC地址作为标识符）
+ 计算到根节点的最短路径：
  + 最短路径不能形成环路
  + 只保留最短路径上的链路
  + 当有多条到根的最短路径时，选择使用ID较小的哪个邻居的路径
    + 可以使用任意的tiebreaking系统，但这是一个易于记忆和实现的系统



构建一个生成树：

+ MESSAGES（Y, d, X）
  + X表示发送消息的节点
  + Y表示建议的根节点
  + d表示到Y的距离
+ 选择具有最小标识符的节点作为根节点
+ 每个节点都只保留到根接地那的最短路径上的链路



步骤：

+ 初始状态下，每个节点都将自己作为根节点提议
  + 节点向其邻居广播消息（X, 0, X）
+ 节点会更新它们对根节点的视图
+ 节点计算到根节点的距离，将从邻居收到的最短距离+1
+ 如果根节点或到根节点的最短距离发生了变化，则向邻居发送更新后的消息



### 生成树算法的鲁棒性

+ 故障
  + 根节点故障：生成树算法会选择一个新的根节点
  + 其他桥接器和链路故障：生成树算法会调整生成树的拓扑结构，排除故障的部分
+ 根节点会发送定期的根节点公告消息，以保持通信
  + 其他节点会继续转发消息
+ 超时故障检测：如果一个桥接器在一段时间内没有收到来自根节点的消息，它会将宣布自己为新的根节点，并重新开始生成树算法的过程



### 生成树算法的泛洪

生成树上进行泛洪操作时（确保了数据包在生成树上进行广播）：

+ 忽略不再生成树上的所有端口
+ 源桥接器将数据包发送到所有端口上
+ 当数据包从个端口进入时，该端口以外的所有端口都将数据包发送出去



这样的操作是否浪费？

+ 是的，但是泛洪被用作网络中更高效转发的初始步骤：
  + 观察泛洪传输的数据包，并从中学习以优化未来的转发过程
  + 如果一个节点A观察到一个来自B的包到达了一个特定的端口，那么其就知道了这个端口可以到达B







## 地址学习

+ 每个桥接器都维护着一个转发数据库，用于学习和记录与各个端口关联的MAC地址消息。
+ 当数据帧到达了否个端口X，那么说明该数据帧来自连接到该端口X的局域网。桥接器会根据数据帧的源地址更新转发数据库，将该地址与端口X相关联
+ 转发数据库中的每个条目都有一个定时器，在定时器超时时会被删除。每次数据帧到达时，源地址会与转发数据库中的条目进行比对，以确定通过哪个端口转发该数据帧



### 桥接器转发总结

+ 每个端口维护一个转发数据库：其中记录了通过该端口可到达的站点地址的MAC地址、端口和时间戳信息
+ 对于从X到达的帧：
  + 在转发表中搜索目标MAC是否在任何端口的列表中
    + 如果找不到，除了端口X进行泛洪
    + 如果在端口X，丢弃该帧
    + 如果在端口Y，检查Y的状态（阻塞或者转发），如果是转发状态，则进行转发
+ 阻塞状态用于形成一个树状结构



## 连接局域网之间的设备

+ 集线器：物理中继器，用于将局域网上的数据包进行广播传输，将收到的数据包复制到所有连接的端口上
+ 桥接器：用于连接不同的局域网，具有转发和地址学习功能
+ 二层交换机：用于连接主机和局域网，具有桥接器的功能，同时能够进行无碰撞的转发
+ 三层交换机：具备路由器功能，甚至可以说路由器是一种更高级和功能更强大的第三层交换机



### 集线器

+ 星型布局的主要组成部分
+ 每个站点通过两条线路连接到集线器上，一条用于发送数据，一条用于接收数据。集线器相当于一个中继器，当一个站点发送数据时，集线器会将该信号重复发送到所有与其连接到的站点上

+ 集线器的一个缺点是它们工作在共享媒体环境中。如果两个或者更多的站点同时发送数据，会发送碰撞。集线器常常被交换机取代，交换机提供了独立的通信路径，提供了无碰撞传输



### 二层交换机

+ 作为链路层设备，扮演主动角色
  + 存储和转发以太网帧
  + 检查传入帧的MAC地址，有选择地将帧转发到一个或多个出站链路。当要进行转发时，使用CSMA/CD
+ 透明性：主机不知道交换机的存在
+ 即插即用，自学习：交换机无须配置
+ 与桥接器的区别：
  + 桥接器用于连接局域网（2-4个端口）
  + 交换机用于连接多个主机\子网（具有很多端口，并可实现无冲突传输）



使用交换机：

+ 在交换机中，每个节点都有专用的直接连接。交换机会缓存和转发帧。
+ 每个传入链路上都使用以太网协议，但没有碰撞
+ 支持全双工通信，每个链路都是一个独立的碰撞域
+ 多个节点可以同时传输，提高了网络的吞吐量和效率



#### 二层交换机的好处

1. 不需要改变连接到交换机的节点，即可将总线/集线器型局域网转换为交换型局域网
   1. 对于每个以太网局域网，每个节点使用以太网MAC协议
2. 每个节点都具有与原始局域网相同的专用容量
   1. 如果交换机具有足够的容量以根上所有节点的传输速率
3. 二层交换机易于扩展，可以增加新的交换机来容纳额外的站点



当然在交换机的视角中，仍然会出现广播风暴问题，仍然使用生成树算法来解决这个问题



#### 交换机转发总结

+ 当交换机接收到帧时：
  + 记录输入链路和发送主机的MAC地址
  + 使用目标MAC地址索引交换机表
  + 如果找到目标地址的表项，则执行以下操作：
    + 如果目标在与帧到达链路想用的段上，则丢弃该帧
    + 否则，根据表项指示的接口将帧转发出去
  + 如果没有找到，泛洪：在除了到达接口之外的所有接口上转发该帧



### 三层交换机

随着节点数量的增加，第二层交换机会显露出一些不足之处：

+ 广播负载过大：随着节点数量的增加，广播消息会增加，导致网络中的广播风暴和带宽浪费
+ 缺乏多路径：第二层交换机通常只有单一路径连接到各个节点，这限制了网络的冗余和容错能力

为了解决这些问题，引入了第三层交换机：

+ 第三层交换机在硬件中实现了路由器的数据包转发裸机，即实现了IP协议的转发功能
+ 它能够连接类似的局域网，就像第二层交换机一样，但是同时具备路由器的功能



广播负荷过大：IP协议在日常工作中会生成许多的广播消息，如ARP、DHCP、IGMP等协议的广播消息会增加网络的广播负荷

缺乏路径：缺乏多路径是指在使用第二层交换机进行路由时，因为使用了生成树算法，导致任意两个站点只有一条路径，这限制了性能和可靠性

解决方式：

+ 将局域网划分成由交换机使用路由器功能连接的子网络。通过引入路由器（或者3层交换机），可以在子网络之间建立多条路径
+ 在每个子网络内限制MAC广播帧的范围，使其仅在单个子网络内传播，从而减少广播帧的数量和影响范围







