# IP协议套件

+ NAT
+ ARP（在链路层中）
+ DHCP（在链路层中）
+ ICMP
+ Mobile IP
+ IPv6



## NAT

+ 用于内部网络和外部网络之间实现不同的IP地址集合
+ 内部网络与更大范围的互联网接口处进行IP地址转换



### NAT的目的

+ 作为防火墙
+ 提供更多的内部IP地址
+ 隔离组织或ISP变更



### NAT的类型

+ 静态NAT：
  + 将私有的IP地址与一个固定的公共IP进行映射
  + 这样可以实现服务器在互联网上的可访问性
+ 动态NAT：
  + NAT路由器维护一个注册的IP地址池，并根据需要将其分配给内部网络中的私有IP地址
  + 在动态NAT中，当客户端需要访问互联网是，NAT路由器就会动态地将一个可用的公共IP地址分配给主机



### NAT的争议

+ IP地址的变化：IP地址的转换，使得外部网络和内部网络之间无法进行IP地址的转换
+ SKYPE中的中继：SKYPE需要先和中继服务器连接，通过中继服务器来和用户进行连接，从而穿越NAT，但是这种中继技术会增加延迟并可能影响通信质量





## ICMP

ICMP是一种用于在路由器和主机只拿传输错误和控制消息的协议

+ 回显请求和恢复：诊断网络连接的可用性和延迟
+ 传递问题反馈：TTL或主机不可达

+ 因为ICMP是一个辅助协议，所以它不提供可靠的传输保证，因此在传输过程中可能会出现丢失或延迟



### ICMP应用：PING

Ping是一种常用的网络探测工具，用于测试目标主机或路由器的可达性。它通过ICMP来实现



Ping的工作过程如下：

+ 源主机发送一个ICMP回显请求（ECHO REQUEST）消息到目标主机或路由器
+ 如果目标系统接收到ICMP数据包，它会向源主机发送回一个回显回复（ECHO REPLY）消息
+ 源主机接收到回显回复消息后，可以进一步计算往返时间和跳等信息（TTL）



### ICMP应用：Traceroute

Traceroute是一种测量到达目标主机所需的跳数的工具，它通过使用ICMP协议和逐条递增的TTL来实现



Traceroute的工作过程如下：

+ 源主机会发送一个TTL值设置为1的IP（UDP）包
+ 第一个路由器将TTL值减少到0，并将该包丢弃，发送一个TTL过期的消息给源主机
+ 源主机根据收到的TTL消息计算往返时间，并再次发送TTL在原基础上+1的数据包，一直重复这个过程，直到主机不可达
+ Trace工具工具会记录每个数据包经过的路由器，从而得到跳数信息
+ 需要注意的是，Traceroute会收到动态路由的影响导致每次的结果出现变化



### ICMP应用：Path MTU

Path MTU用于确定到达目的主机的路径上的最小MTU



Path MTU的工作过程如下：

+ 源主机发送了一个设置了不分片位的大型IP数据包

+ 如果数据包超过了某个路由器的MTU，会发送一个“参数不可理解”的ICMP错误
+ 源主机根据收到的信息修改MTU然后重复上述过程直到不再收到ICMP报错信息
+ 当然也受到动态路由的影响



## IPv6

IPv6是为了解决地址空间枯竭问题而推出的



格外的优势：

+ 新的报文头格式：新的报文头格式有助于加快处理和转发数据包的速度，简化了路由器的处理过程
+ 改进服务质量（QoS）支持
+ 路由器不进行分片：IPv6要求发送端进行分片，而不是使用路由器进行分片。
+ 新的地址模式：可以通过路由到多个复制服务器中的最佳服务器来实现更高的负载均衡和可靠性



IPv6没有广播、没有ARP、有了icmpv6



IPv6不同的地址：

+ 单播地址
+ 多播地址
+ 回环地址
+ 未指定地址

### 



### IPv6和IPv4的优缺点

+ 扩展的寻址能力
  + 组播地址的可扩展性
  + 任播功能
  + 地址自动配置
+ 改进的选项机制
  + IPv6采用了独立的可选头部，位于IPv6和传输层头部之间，大部分可选头部不会被中间路由器检查，使得选项的扩展更加方便
  + 去除了校验和
+ 支持资源分配
  + 引入了流量差别
  + 可以对数据包进行分组，实现特定流量的资源分配
  + 支持除了“尽力而为”之外的服务质量（QoS）处理
+ 更高效和可靠的移动性机制：更加的高效和健壮
+ 更加安全：内置了强大的IP加密和身份验证机制



### 两种过度手段

+ 双栈：部分路由器同时支持IPv6和IPv4

  + 需要IPv4和IPv6之间的翻译
  + 一些IPv6特性丢失

+ 隧道：将IPv6数据报封装进IPv4数据报中

  + 看起来不错，但是让效率低下了

  





