# 互联网路由协议

我们之前讨论的理论研究还存在着一些问题

+ 规模问题
  + 互联网有数亿个目的地，无法在每个路由器中存储所有目的地的路由表
  + 存储和交换如此庞大的路由表会消耗大量的资源并占用大量链路带宽
+ 路由表交换问题
  + 由于互联网的规模和复杂性，完全交换路由表会导致链路拥塞和性能的下降
+ 管理自治
  + 互联网是网络的网络
  + 每个网络的管理者希望能够自己控制自己的网络



## 层次化路由

+ 将路由器组织成区域，形成自治系统（AS）
+ 在统一自治系统内的路由器运行相同的路由协议，自治系统内路由协议
+ 网关路由器：自治系统内的路由器负责将数据转发到自治系统外部的目的地





## AS（自治系统）

+ AS是被ISP和大型组织管理的路由器和网络的集合
+ 每个自治系统被分配了16或32比特的自治号
  + 自治系统内的所有节点至少存在着一条路由
+ 自治系统使用共同的路由控制和交换



## 网关协议

### 内部网关协议IGP

+ 用于自治系统内部的路由控制
+ 专注性能方面的考虑
+ 不同自治系统之间的路由算法和路由表可能有所不同



主要包含三种协议：

+ RIP：使用距离向量
+ OSPF：链路状态
+ IGRP



#### RIP

+ 距离向量算法
+ 每个节点和邻居交换信息
+ 每个节点维护向量信息
+ 距离向量算法是一种分布式算法，每个节点根据收到的邻居节点的距离向量信息来更新自己的路由表
  + 花费很长时间
+ UDP



#### OSPF

每个路由器初始化的时候，确定每个链路成本，并向其他路由器进行广告

+ 不适用分布算法，一般使用Dijkstra算法
+ IP



先进的特性：

+ 安全性：进行身份验证
+ 允许多条相同成本的路径
+ 对于不同的类型服务，可以为每个链路设置多个成本度量标准
+ 支持单播和多播
+ 大型域中，可以使用分层的OSPF来组织网络



#### RIP和OSPF

| RIP  | 优点                                 | 缺点                               |
| ---- | ------------------------------------ | ---------------------------------- |
|      | 配置简单，适用于小型网络（小于15跳） | 收敛速度慢                         |
|      | 可分步实现                           | 网络是一个平面，不适用于大规模网络 |
| OSPF |                                      |                                    |
|      | 收敛速度快，无跳数限制               | 集中式算法                         |
|      | 支持不同服务类型选路                 | 每个节点需要维护全局拓扑           |
|      | 支持身份认证                         | 配置复杂                           |
|      | 支持层次式网络，适用于大规模复杂网络 |                                    |





### 外部网关协议EGP

+ 当路由器需要自治系统外部网络信息时，EFP提供了支持
+ 政策会主导性能方面的考虑



主要使用一种协议：

+ BGP



管理结构塑造了域间路由的特性

+ 每个AS想要自由选择路由选择策略
+ 每个AS想要自治权
+ 每个AS想要隐私权



#### BGP和距离向量的四个区别

+ 不选择最短路由，而是选择最佳路由
+ 路径向量路由：广播整个路由
  + 回避环路（丢弃环路路径）
  + 基于整个路径的灵活和有表现力的策略
+ 选择性路由广播
  + 一个AS可能选择不想目的地广告路由
  + 即便物理上连接，可达性也不能保证
+ 路由聚合



#### BGP协议细节

+ 边界路由器是一个自治系统
+ 边界路由器使用eBGP会话与其他AS中的边界路由器进行BGP通信
+ 边界路由器与同一自治系统中的路由器通过使用iBGP进行BGP通信



##### eBGP iBGP IGP

+ eBGP：不同自治系统之间的边界路由器之间建立的BGP会话，它用于学习外部目标的路由
+ iBGP：同一自治系统内的边界路由器和其他路由器之间建立的BGP会话，iBGP用来在自治系统内部分发从外部学习到路由信息
  + 它同时也确保了在同一自治系统内的所有路由器都具有相同的路由信息
+ IGP：指的是自治系统内部的路由协议，也称域内路由协议。它提供了自治系统内部的可达性



这三者在一起发挥出了作用：

+ 使用eBGP去在外部网络中学习路由
+ 使用iBGP在内部网络中分发额外学习的路由
+ 使用IGP在自治系统内部确定到出口点的最短路径



#### 路由更新

路由更新分为两种类型的信息：

+ 通告：只对新的路由或对现有路由的更新
+ 撤回：指移除不再存在的路由





####  路由属性

+ AS Path：	
  + 在路由通告中传输，提供关于路由的路径信息
  + 避免环路
+ 本地优先级：
  + 用在不同的AS路径之间进行选择时的首选路径
  + 值越高，表示越收到AS内部喜好

+ 多重出口区分器（MED）
  + MED的值越低越好，表示其和AS出口的远近关系
+ IGP成本是指内部域内的路由协议
  + 每个路由器根据域内的路径成本选择最近的出口点。也就是路由器倾向于通过具有最低IGP成本的出口点将流量发送到相邻的自治系统中



#### BGP协议特点：

+ 主要用于表示路由的可达性，不一定走最短路径路由 
+ 通过携带AS路径信息，可以解决路由循环问题
+ 使用TCP协议，可以解决路由循环问题
+ BGP协议交换路由信息的节点数量级是自治系统数量
+ 支持CIDR，可以进行路由聚合
+ 在BGP刚刚开始运行时，BGP邻站交换整个的BGP路由表。但以后只需要在发生变化时增量更新有变化的部分，减少开销



